// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enhanced Tenant model (migrated from Redis SubdomainData)
model Tenant {
  id                  String   @id @default(cuid())
  subdomain           String   @unique
  emoji               String   @default("üè¢")
  businessName        String
  businessCategory    String
  ownerName           String
  email               String
  phone               String
  address             String?
  businessDescription String?
  logo                String?
  
  // Brand colors as JSON
  brandColors         Json?
  
  // Feature flags
  whatsappEnabled     Boolean  @default(false)
  homeVisitEnabled    Boolean  @default(false)
  analyticsEnabled    Boolean  @default(false)
  customTemplatesEnabled Boolean @default(false)
  multiStaffEnabled   Boolean  @default(false)
  
  // Subscription info
  subscriptionPlan    String   @default("basic") // basic, premium, enterprise
  subscriptionStatus  String   @default("active") // active, suspended, cancelled
  subscriptionExpiresAt DateTime?
  
  // Security fields for owner
  passwordHash        String?  // Hashed password for owner
  lastLoginAt         DateTime?
  loginAttempts       Int      @default(0)
  lockedUntil         DateTime?
  passwordResetToken  String?
  passwordResetExpires DateTime?
  
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  services            Service[]
  customers           Customer[]
  bookings            Booking[]
  staff               Staff[]
  whatsappDevices     WhatsAppDevice[]
  conversations       Conversation[]
  messageTemplates    MessageTemplate[]
  businessHours       BusinessHours?
  invoices            Invoice[]
  serviceAreas        ServiceArea[]
  
  @@map("tenants")
}

// Service model
model Service {
  id                  String   @id @default(cuid())
  tenantId            String
  name                String
  description         String
  duration            Int      // minutes
  price               Decimal  @db.Decimal(10, 2)
  category            String
  isActive            Boolean  @default(true)
  homeVisitAvailable  Boolean  @default(false)
  homeVisitSurcharge  Decimal? @db.Decimal(10, 2)
  images              String[] // Array of image URLs
  requirements        String[] // Array of requirements
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings            Booking[]
  invoiceItems        InvoiceItem[]
  
  @@map("services")
}

// Customer model
model Customer {
  id                  String   @id @default(cuid())
  tenantId            String
  name                String
  email               String?
  phone               String
  address             String?
  notes               String?
  totalBookings       Int      @default(0)
  lastBookingAt       DateTime?
  whatsappNumber      String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  bookings            Booking[]
  conversations       Conversation[]
  invoices            Invoice[]
  
  @@map("customers")
}

// Booking model
model Booking {
  id                  String   @id @default(cuid())
  tenantId            String
  customerId          String
  serviceId           String
  status              String   @default("pending") // pending, confirmed, completed, cancelled, no_show
  scheduledAt         DateTime
  duration            Int      // minutes
  isHomeVisit         Boolean  @default(false)
  homeVisitAddress    String?
  homeVisitCoordinates Json?   // {lat: number, lng: number}
  notes               String?
  totalAmount         Decimal  @db.Decimal(10, 2)
  paymentStatus       String   @default("pending") // pending, paid, refunded
  remindersSent       DateTime[] // Array of reminder timestamps
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  service             Service  @relation(fields: [serviceId], references: [id], onDelete: Cascade)
  invoices            Invoice[]
  
  @@map("bookings")
}

// Staff model for multi-staff support
model Staff {
  id                  String   @id @default(cuid())
  tenantId            String
  name                String
  email               String
  phone               String?
  role                String   @default("staff") // admin, staff
  permissions         String[] // Array of permissions
  isActive            Boolean  @default(true)
  
  // Security fields
  passwordHash        String?  // Hashed password
  lastLoginAt         DateTime?
  loginAttempts       Int      @default(0)
  lockedUntil         DateTime?
  passwordResetToken  String?
  passwordResetExpires DateTime?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  assignedConversations Conversation[]
  
  @@map("staff")
  @@unique([tenantId, email])
}

// WhatsApp Device model
model WhatsAppDevice {
  id                  String   @id @default(cuid())
  tenantId            String
  deviceName          String
  phoneNumber         String
  status              String   @default("disconnected") // connected, disconnected, connecting
  lastSeen            DateTime?
  qrCode              String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("whatsapp_devices")
}

// Conversation model
model Conversation {
  id                  String   @id @default(cuid())
  tenantId            String
  customerId          String
  whatsappNumber      String
  lastMessageAt       DateTime @default(now())
  unreadCount         Int      @default(0)
  assignedToId        String?  // staff member ID
  status              String   @default("active") // active, archived
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  assignedTo          Staff?   @relation(fields: [assignedToId], references: [id], onDelete: SetNull)
  messages            Message[]
  
  @@map("conversations")
}

// Message model
model Message {
  id                  String   @id @default(cuid())
  conversationId      String
  type                String   @default("text") // text, image, file, voice, template
  content             String
  mediaUrl            String?
  isFromCustomer      Boolean  @default(true)
  deliveryStatus      String   @default("sent") // sent, delivered, read, failed
  sentAt              DateTime @default(now())
  
  // Relations
  conversation        Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  
  @@map("messages")
}

// Message Template model
model MessageTemplate {
  id                  String   @id @default(cuid())
  tenantId            String
  name                String
  content             String
  variables           String[] // e.g., ['CustomerName', 'BookingDate', 'ServiceName']
  category            String   @default("reminder") // reminder, confirmation, follow_up, marketing
  isActive            Boolean  @default(true)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("message_templates")
}

// Business Hours model
model BusinessHours {
  id                  String   @id @default(cuid())
  tenantId            String   @unique
  schedule            Json     // Schedule configuration as JSON
  timezone            String   @default("Asia/Jakarta")
  
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("business_hours")
}

// Invoice model
model Invoice {
  id                  String   @id @default(cuid())
  tenantId            String
  customerId          String
  bookingId           String?
  invoiceNumber       String   @unique
  status              String   @default("draft") // draft, sent, paid, overdue, cancelled
  issueDate           DateTime @default(now())
  dueDate             DateTime
  paidDate            DateTime?
  
  // Financial details
  subtotal            Decimal  @db.Decimal(10, 2)
  taxRate             Decimal  @db.Decimal(5, 4) @default(0) // e.g., 0.1000 for 10%
  taxAmount           Decimal  @db.Decimal(10, 2) @default(0)
  discountAmount      Decimal  @db.Decimal(10, 2) @default(0)
  totalAmount         Decimal  @db.Decimal(10, 2)
  
  // Payment details
  paymentMethod       String?  // cash, bank_transfer, credit_card, digital_wallet, other
  paymentReference    String?
  
  // Invoice content
  notes               String?
  terms               String?
  
  // QR code for payment
  qrCodeData          String?
  qrCodeUrl           String?
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  customer            Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)
  booking             Booking? @relation(fields: [bookingId], references: [id], onDelete: SetNull)
  items               InvoiceItem[]
  
  @@map("invoices")
}

// Invoice Item model
model InvoiceItem {
  id                  String   @id @default(cuid())
  invoiceId           String
  description         String
  quantity            Int      @default(1)
  unitPrice           Decimal  @db.Decimal(10, 2)
  totalPrice          Decimal  @db.Decimal(10, 2)
  serviceId           String?
  
  // Relations
  invoice             Invoice  @relation(fields: [invoiceId], references: [id], onDelete: Cascade)
  service             Service? @relation(fields: [serviceId], references: [id], onDelete: SetNull)
  
  @@map("invoice_items")
}

// Service Area model for home visit coverage
model ServiceArea {
  id                  String   @id @default(cuid())
  tenantId            String
  name                String
  description         String?
  isActive            Boolean  @default(true)
  
  // Geographic boundaries as JSON
  boundaries          Json     // ServiceAreaBoundary type
  
  // Pricing and logistics
  baseTravelSurcharge Decimal  @db.Decimal(10, 2)
  perKmSurcharge      Decimal? @db.Decimal(10, 2)
  maxTravelDistance   Decimal  @db.Decimal(8, 2) // in kilometers
  estimatedTravelTime Int      // base travel time in minutes
  
  // Service availability
  availableServices   String[] // service IDs
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  // Relations
  tenant              Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  
  @@map("service_areas")
  @@index([tenantId, isActive])
}

// Super Admin model for platform-wide access
model SuperAdmin {
  id                  String   @id @default(cuid())
  email               String   @unique
  name                String
  isActive            Boolean  @default(true)
  
  // Security fields
  passwordHash        String
  lastLoginAt         DateTime?
  loginAttempts       Int      @default(0)
  lockedUntil         DateTime?
  passwordResetToken  String?
  passwordResetExpires DateTime?
  
  // Permissions and access
  permissions         String[] @default(["*"]) // Platform-wide permissions
  canAccessAllTenants Boolean  @default(true)
  
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt
  
  @@map("super_admins")
}

// Security Audit Log model
model SecurityAuditLog {
  id                  String   @id @default(cuid())
  tenantId            String
  userId              String
  action              String   // login, logout, create_booking, delete_customer, etc.
  resource            String?  // booking_id, customer_id, etc.
  ipAddress           String
  userAgent           String
  success             Boolean  @default(true)
  details             String?  // JSON string with additional details
  timestamp           DateTime @default(now())
  
  @@map("security_audit_logs")
  @@index([tenantId, timestamp])
  @@index([userId, timestamp])
  @@index([action, timestamp])
}
